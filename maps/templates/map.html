<!DOCTYPE html>
<html>
    {% load static %}
<head>
    <title>Google Map Route Finder</title>


    <!-- Bootstrap CSS and JS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" type="text/css" href="{% static 'maps/map.css' %}">
</head>

<body>
    <!-- <nav>
        <h3>Find a Route on Google Maps</h3>
        {% if user.is_authenticated %}
        <h3>Hi, {{user.username}}</h3>
        <div>
            {% if user.is_superuser %}
            <a href="{% url 'admin_panel:user-list' %}"><button>Admin Panel</button></a>
            {% endif %}
            <a href="{% url 'messaging:inbox' %}"><button>Messages</button></a>
            <a href="{% url 'app:alerts' %}"><button>Alerts</button></a>
            <a href="{% url 'notifications:inbox' %}"><button>Notifications</button></a>
            <a href="{% url 'app:stations' %}"><button>Subway</button></a>
            <a href="{% url 'reporting:reporting_form' %}"><button>Report</button></a>
            <form method="POST" action="{% url 'app:logout' %}">
                {% csrf_token %}
                <button type="submit">Logout</button>
            </form>
            <a href="{% url 'app:profile' %}"><button>Profile</button></a>
        </div>
        {% else %}
        <div>
            <a href="{% url 'app:alerts' %}"><button>Alerts</button></a>
            <a href="{% url 'notifications:inbox' %}"><button>Notifications</button></a>
            <a href="{% url 'app:login' %}"><button>Login</button></a>
            <a href="{% url 'app:register' %}"><button>Register</button></a>
            <a href="{% url 'app:stations' %}"><button>Subway</button></a>
        </div>
        {% endif %}
    </nav> -->

    <!-- Main Navigation Bar (Common for all users) -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <h3>StepFreeMTA</h3>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#mainNav" aria-controls="mainNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="mainNav">
        <ul class="navbar-nav ml-auto">
            <li class="nav-item">
                <a class="nav-link" href="{% url 'app:alerts' %}">
                    <i class="bi bi-bell"></i> Alerts
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{% url 'notifications:inbox' %}">
                    <i class="bi bi-bell-fill"></i> Notifications
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{% url 'app:stations' %}">
                    <i class="bi bi-subway"></i> Subway
                </a>
            </li>
            {% if user.is_authenticated %}
            <li class="nav-item">
                <form method="POST" action="{% url 'app:logout' %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-box-arrow-right"></i> Logout
                    </button>
                </form>
            </li>
            {% else %}
            <li class="nav-item">
                <a class="nav-link" href="{% url 'app:login' %}">
                    <i class="bi bi-box-arrow-in-right"></i> Login
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{% url 'app:register' %}">
                    <i class="bi bi-person-plus"></i> Register
                </a>
            </li>
            {% endif %}
        </ul>
    </div>
</nav>

<!-- Secondary Navigation Bar (Visible for logged-in users only) -->
{% if user.is_authenticated %}
<nav class="navbar navbar-expand-lg navbar-light bg-light">
   
        <h3 style="color: black;">
            <i class="bi bi-person-circle"></i> Welcome, <strong>{{ user.username }}</strong>
        </h3>
        <div class="collapse navbar-collapse" id="userNav">
            <ul class="navbar-nav ml-auto">
                {% if user.is_superuser %}
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'admin_panel:user-list' %}">
                        <i class="bi bi-speedometer2"></i> Admin Panel
                    </a>
                </li>
                {% endif %}
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'messaging:inbox' %}">
                        <i class="bi bi-envelope"></i> Messages
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'reporting:reporting_form' %}">
                        <i class="bi bi-flag"></i> Report an Issue
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'app:profile' %}">
                        <i class="bi bi-person"></i> Profile
                    </a>
                </li>
            </ul>
        </div>
    
</nav>
{% endif %}


    <!-- Input fields and button for user input -->
    <div id="controls">
        <label for="start">Starting Point:</label>
        <input type="text" id="start" placeholder="Enter starting location" onchange="resetStartLocation()">
        <button onclick="useCurrentLocation()">Use Current Location</button>
        <button id="set-start-point" onclick="enableLocationSelection('start')">
            <img src="http://maps.google.com/mapfiles/markerA.png">
        </button>


        <label for="end">Ending Point:</label>
        <input type="text" id="end" placeholder="Enter destination" onchange="resetEndLocation()">
        <button id="set-end-point" onclick="enableLocationSelection('end')">
            <img src="http://maps.google.com/mapfiles/markerB.png">
        </button>
        
        {% if user.is_authenticated %}
        <button id="saveFavoriteButton" onclick="saveFavorite()">
            ❤️
        </button>
        {% endif %}

        <button onclick="findRoute()">Find Route</button>

        <!-- Slider Container with Fixed Width for Radius Value -->
        <div class="slider-container">
            <label for="radius-slider" class="slider-label">
                Radius: <span id="radius-value" style="display: inline-block; width: 30px; text-align: right;">2.0</span> miles
            </label>
            <input type="range" id="radius-slider" min="0.5" max="5" step="0.1" value="2" oninput="updateRadiusLabel()">
        </div>
        
        <!-- Toggle Nearby Stations Button -->
        <button id="toggle-stations-button" onclick="toggleNearbyStations()">Show Nearby Accesible Subway Stations</button>

        <!-- Accessibility toggle button -->
        <div class="dropdown">
            <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="bi bi-person-wheelchair"></i> Accessibility Options
            </button>
            <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                <a class="dropdown-item" href="#" onclick="setFilter('accessible')">Accessible Stations</a>
                <a class="dropdown-item" href="#" onclick="setFilter('all')">All Stations</a>
                <a class="dropdown-item" href="#" onclick="setFilter('hide')">Hide All</a>
            </div>
        </div>        
    </div>

    <!-- Map container and route steps side by side -->
    <div id="map-container">
        <!-- Directions List on the left -->
        <div id="route-steps" style="display: none;">
            <h3>Route Steps</h3>
            <ul id="directions-list"></ul>

            {% if nearest_station_name %}
            <h4>Nearest Accessible Station:</h4>
            <p><strong>{{ nearest_station_name }}</strong> (Lat: {{ nearest_station_lat }}, Lng: {{ nearest_station_lng }})</p>
            {% elif nearest_station_error %}
            <p>{{ nearest_station_error }}</p>
            {% endif %}
        </div>

        <!-- Map on the right -->
        <div id="map"></div>
    </div>
    
    <!-- Add json_script to safely embed JSON for accessible subway data -->
    {{ accessible_stations_with_reviews|json_script:"accessible-stations" }}

    <script>
        let map, directionsService, placesService, currentLocationMarker, blueDotMarker;
        let startMarker, endMarker;
        let polylines = []; // Array to store polylines
        let directionsRenderers = []; // Array to store DirectionsRenderer instances
        let nearbyStationMarkers = []; // Array to store nearby subway station markers
        let stationsVisible = false; // Tracks visibility of subway stations
        let startLocation = null; // To store starting point coordinates
        let endLocation = null;   // To store ending point 
        let stationVisibility = 'all'; // Initial state for accessible data layer
        let activeInfoWindow = null;
        let settingLocation = null;
        let mapClickListener = null;
        let destinationMarker = null;
        let startingPointMarker = null;

        // Define nearest accessible station data from Django context
        const nearestStationName = "{{ nearest_station_name|escapejs }}";
        const nearestStationLat = parseFloat("{{ nearest_station_lat }}");
        const nearestStationLng = parseFloat("{{ nearest_station_lng }}");

        // Accessible stations data loaded from Django context safely as JSON
        const accessibleStations = JSON.parse(document.getElementById('accessible-stations').textContent);

        // Color map for NYC subway lines
        const subwayLineColors = {
            'A': '#0039A6',   // Blue
            'C': '#0039A6',   // Blue
            'E': '#0039A6',   // Blue
            'B': '#FF6319',   // Orange
            'D': '#FF6319',   // Orange
            'F': '#FF6319',   // Orange
            'M': '#FF6319',   // Orange
            'G': '#6CBE45',   // Light Green
            'L': '#A7A9AC',   // Gray
            '1': '#EE352E',   // Red
            '2': '#EE352E',   // Red
            '3': '#EE352E',   // Red
            '4': '#00933C',   // Green
            '5': '#00933C',   // Green
            '6': '#00933C',   // Green
            'N': '#FCCC0A',   // Yellow
            'Q': '#FCCC0A',   // Yellow
            'R': '#FCCC0A',   // Yellow
            'J': '#996633',   // Brown
            'Z': '#996633',   // Brown
            'W': '#FCCC0A',   // Yellow
            '7': '#B933AD',   // Purple
        };

        let selectedStationMarker = null;

        // Initialize the map
        function initMap() {

            // Initialize the map centered on New York City
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 13,
                center: { lat: 40.7128, lng: -74.0060 }, // Default to New York City
            });

            initAutocomplete();

            // Set up the map click listener
            mapClickListener = map.addListener('click', function (event) {
                if (!settingLocation) {
                    return; // Ignore clicks if not in selection mode
                }

                const selectedLocation = {
                    lat: event.latLng.lat(),
                    lng: event.latLng.lng(),
                };

                if (settingLocation === 'start') {
                    startLocation = selectedLocation; // Update the global start location
                    document.getElementById('start').value = `${selectedLocation.lat.toFixed(5)}, ${selectedLocation.lng.toFixed(5)}`;
                    alert("Starting point set.");

                    // Add or update the starting point marker
                    if (startingPointMarker) {
                        startingPointMarker.setMap(null); // Clear the previous marker
                    }
                    startingPointMarker = new google.maps.Marker({
                        position: selectedLocation,
                        map: map,
                        title: "Starting Point",
                        icon: "http://maps.google.com/mapfiles/markerA.png", // Purple pin
                    });
                } else if (settingLocation === 'end') {
                    endLocation = selectedLocation; // Update the global end location
                    document.getElementById('end').value = `${selectedLocation.lat.toFixed(5)}, ${selectedLocation.lng.toFixed(5)}`;
                    alert("Destination set.");

                    // Add or update the destination marker
                    if (destinationMarker) {
                        destinationMarker.setMap(null); // Clear the previous marker
                    }
                    destinationMarker = new google.maps.Marker({
                        position: selectedLocation,
                        map: map,
                        title: "Destination",
                        icon: "http://maps.google.com/mapfiles/markerB.png", // Red pin
                    });
                }

                // Reset the selection state and restore cursor
                settingLocation = null;
                map.setOptions({ draggableCursor: null });
            });

            // map.addListener("click", function(e) {
            //     const clickLat = e.latLng.lat();
            //     const clickLan = e.latLng.lng();
            //     console.log("clicking",clickLat, clickLan);
            //     endLocation = { lat: clickLat, lng: clickLan };
            //     document.getElementById('end').value = `${clickLat}, ${clickLan}`;
            // });

            // Load GeoJSON data for subway stations
            map.data.loadGeoJson(
                "https://data.ny.gov/resource/39hk-dx4f.geojson",
            );

            // Initial filter to show only accessible stations
            setStationFilter();

            map.data.addListener('click', function (event) {
                // Get clicked location's latitude and longitude
                const latitude = event.latLng.lat();
                const longitude = event.latLng.lng();

                // Find the nearest station from accessibleStations
                let nearestStation = null;
                let shortestDistance = Infinity;

                accessibleStations.forEach((station) => {
                    const stationLat = parseFloat(station.gtfs_latitude);
                    const stationLng = parseFloat(station.gtfs_longitude);

                    // Skip if lat/lng are invalid
                    if (isNaN(stationLat) || isNaN(stationLng)) {
                        return;
                    }

                    // Calculate distance
                    const distance = calculateDistance(
                        { lat: latitude, lng: longitude },
                        { lat: stationLat, lng: stationLng }
                    );

                    // Update nearest station
                    if (distance < shortestDistance) {
                        shortestDistance = distance;
                        nearestStation = station;
                    }
                });

                if (nearestStation) {
                    const reviews = nearestStation.reviews || [];
                    const avgRating = nearestStation.avg_rating ? `${nearestStation.avg_rating}/5` : "No rating available";

                    // Format reviews for the popup
                    const reviewContent = reviews
                        .map(review => `<p><strong>${review.user}:</strong> ${review.comment}</p>`)
                        .join("");

                    // Construct InfoWindow content
                    const infoContent = `
                        <div style="font-size: 14px; max-width: 250px;">
                            <strong>${nearestStation.stop_name}</strong><br>
                            Train Lines: ${nearestStation.daytime_routes || "N/A"}<br>
                            Rating: ${avgRating}<br>
                            ${reviewContent || "<p>No reviews yet.</p>"}
                            <a href="https://www.google.com/maps?q=${nearestStation.gtfs_latitude},${nearestStation.gtfs_longitude}" target="_blank">View on Google Maps</a>
                        </div>
                    `;

                    // Close active InfoWindow if one exists
                    if (activeInfoWindow) {
                        activeInfoWindow.close();
                    }

                    // Create and display a new InfoWindow
                    const infoWindow = new google.maps.InfoWindow({
                        content: infoContent,
                        position: { lat: parseFloat(nearestStation.gtfs_latitude), lng: parseFloat(nearestStation.gtfs_longitude) }
                    });
                    infoWindow.open(map);

                    // Update the active InfoWindow reference
                    activeInfoWindow = infoWindow;
                } else {
                    console.log("No nearby station found.");
                }
            });

            const stationLat = parseFloat("{{ lat }}");
            const stationLng = parseFloat("{{ lng }}");
            const stationName = "{{ station_name }}";
            const destStationLat = parseFloat("{{ dest_lat }}");
            const destStationLng = parseFloat("{{ dest_lng }}");

            directionsService = new google.maps.DirectionsService();

            // Initialize PlacesService
            placesService = new google.maps.places.PlacesService(map);

            if (stationLat && stationLng) {
                document.getElementById("start").value = stationName;
                centerMapOnStation(stationLat, stationLng, stationName, map);
            } 
            else {
                // Try to get the user's current location on map load
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const userLocation = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };

                            // Center map on user's location
                            map.setCenter(userLocation);

                            // Add a small blue dot to represent user's location
                            blueDotMarker = new google.maps.Marker({
                                position: userLocation,
                                map: map,
                                icon: {
                                    path: google.maps.SymbolPath.CIRCLE,
                                    scale: 8,
                                    fillColor: '#4285F4',  // Google blue color
                                    fillOpacity: 1,
                                    strokeColor: '#ffffff', // White border
                                    strokeWeight: 2
                                },
                                title: "You are here"
                            });
                        },
                        (error) => {
                            alert("Error fetching current location: " + error.message);
                        }
                    );
                }
            }
            
            // Moved to new if statement to populate destination field
            if (destStationLat && destStationLng) {
                    document.getElementById("end").value = stationName;
                    endLocation = { lat: destStationLat, lng: destStationLng };
                    findRoute();
                }

            // Enable or Disable the "Show Nearby Subway Stations" Button
            const toggleStationsButton = document.getElementById('toggle-stations-button');
            if (navigator.geolocation) {
                // Geolocation is available, enable the button
                toggleStationsButton.disabled = false;
            } else {
                // Geolocation is not available, disable the button and inform the user
                toggleStationsButton.disabled = true;
                toggleStationsButton.innerText = 'Geolocation not available';
            }

            // Add a click listener to the map for location selection
            map.addListener('click', function (event) {
                if (!settingLocation) {
                    return; // Exit if we're not in location selection mode
                }

                const selectedLocation = {
                    lat: event.latLng.lat(),
                    lng: event.latLng.lng()
                };

                if (settingLocation === 'start') {
                    startLocation = selectedLocation; // Update the global start location
                    document.getElementById('start').value = `${selectedLocation.lat.toFixed(5)}, ${selectedLocation.lng.toFixed(5)}`;
                    alert("Starting point set.");
                } else if (settingLocation === 'end') {
                    endLocation = selectedLocation; // Update the global end location
                    document.getElementById('end').value = `${selectedLocation.lat.toFixed(5)}, ${selectedLocation.lng.toFixed(5)}`;
                    alert("Destination set.");
                }

                // Reset the selection state
                settingLocation = null;

                // Restore the default map cursor
                map.setOptions({ draggableCursor: null });

                // Re-enable map interactions if they were disabled
                map.setOptions({ disableDoubleClickZoom: false });
            });
        }
        window.initMap = initMap;

        // Function to center map on a station
        function centerMapOnStation(lat, lng, stationName) {
            const stationLocation = { lat: lat, lng: lng };
            startLocation = stationLocation;
            // Center map on station
            map.setCenter(stationLocation);

            // Add a marker on the station
            if (selectedStationMarker) {
                selectedStationMarker.setMap(null); // Remove previous marker
            }

            selectedStationMarker = new google.maps.Marker({
                position: stationLocation,
                map: map,
                icon: {
                    url: "https://maps.google.com/mapfiles/ms/icons/green-dot.png", // Change color
                },
                title: stationName || "Selected Station",
            });
        }

        function enableLocationSelection(type) {
            if (type === 'start') {
                alert("Click on the map to set the starting point.");
                settingLocation = 'start';
            } else if (type === 'end') {
                alert("Click on the map to set the destination.");
                settingLocation = 'end';
            }

            // Change the map cursor to indicate selection mode
            map.setOptions({ draggableCursor: 'crosshair' });

        }


        function useCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const currentLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };

                        map.setCenter(currentLocation);

                        if (currentLocationMarker) {
                            currentLocationMarker.setMap(null);
                        }

                        // Place a new marker for current location
                        currentLocationMarker = new google.maps.Marker({
                            position: currentLocation,
                            map: map,
                            title: "You are here"
                        });

                        startLocation = currentLocation; // Store coordinates

                        const geocoder = new google.maps.Geocoder();
                        geocoder.geocode({ location: currentLocation }, (results, status) => {
                            if (status === "OK" && results[0]) {
                                document.getElementById("start").value = results[0].formatted_address;
                            } else {
                                alert("Could not determine address for current location.");
                            }
                        });
                    },
                    (error) => {
                        alert("Error fetching current location: " + error.message);
                    }
                );
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        // Toggle function for nearby subway stations
        function toggleNearbyStations() {
            const button = document.getElementById('toggle-stations-button');
            if (!stationsVisible) {
                 // Ensure all accessibility markers are cleared
                setFilter('hide');
                // Show nearby accessible stations within the radius
                findAccessibleStationsWithinRadius();
                stationsVisible = true;
                button.innerText = 'Hide Nearby Subway Stations';
            } else {
                // Hide nearby accessible stations
                clearNearbyMarkers();
                stationsVisible = false;
                button.innerText = 'Show Nearby Subway Stations';
            }
        }

        // Function to create a marker with an optional pixel offset
        function createAlignedMarker(position, map, title, iconUrl, offsetX = 0, offsetY = 0) {
            return new google.maps.Marker({
                position: position,
                map: map,
                title: title,
                icon: {
                    url: iconUrl,
                    anchor: new google.maps.Point(12 + offsetX, 12 + offsetY)  // Adjust these values as needed
                }
            });
        }

        // Utility function to calculate distance between two points in meters
        function calculateDistance(location1, location2) {
            const R = 6371000; // Radius of the Earth in meters
            const dLat = (location2.lat - location1.lat) * (Math.PI / 180);
            const dLng = (location2.lng - location1.lng) * (Math.PI / 180);

            const a = 
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(location1.lat * (Math.PI / 180)) * Math.cos(location2.lat * (Math.PI / 180)) *
                Math.sin(dLng / 2) * Math.sin(dLng / 2);

            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Distance in meters
        }

        function initAutocomplete() {
            const startInput = document.getElementById("start");
            const endInput = document.getElementById("end");

            // Initialize Google Places Autocomplete for starting point
            const startAutocomplete = new google.maps.places.Autocomplete(startInput);
            startAutocomplete.setFields(["geometry", "formatted_address"]);
            startAutocomplete.setComponentRestrictions({ country: "us" });

            startAutocomplete.addListener("place_changed", () => {
                const place = startAutocomplete.getPlace();
                if (place.geometry) {
                    startLocation = {
                        lat: place.geometry.location.lat(),
                        lng: place.geometry.location.lng(),
                    };
                    startInput.value = place.formatted_address; // Update input with formatted address
                    console.log("Start location set:", startLocation);
                } else {
                    alert("No details available for the selected location.");
                }
            });

            // Initialize Google Places Autocomplete for destination
            const endAutocomplete = new google.maps.places.Autocomplete(endInput);
            endAutocomplete.setFields(["geometry", "formatted_address"]);

            endAutocomplete.addListener("place_changed", () => {
                const place = endAutocomplete.getPlace();
                if (place.geometry) {
                    endLocation = {
                        lat: place.geometry.location.lat(),
                        lng: place.geometry.location.lng(),
                    };
                    endInput.value = place.formatted_address; // Update input with formatted address
                    console.log("End location set:", endLocation);
                } else {
                    alert("No details available for the selected location.");
                }
            });
        }

        // Clear nearby station markers
        function clearNearbyMarkers() {
            nearbyStationMarkers.forEach(marker => marker.setMap(null));
            nearbyStationMarkers = [];
        }

        // Update the label showing the radius in miles
        function updateRadiusLabel() {
            const radius = parseFloat(document.getElementById('radius-slider').value);
            document.getElementById('radius-value').innerText = radius.toFixed(1);
        }

        function resetStartLocation() {
            startLocation = null;
        }

        function resetEndLocation() {
            endLocation = null;
        }

        function findRoute() {
            const startInput = document.getElementById('start').value;
            const endInput = document.getElementById('end').value;

            let origin = startLocation || startInput;
            let destination = endLocation || endInput;

            console.log("Starting route from:", origin, "to:", destination); // Log start and destination

            if (origin && destination) {
                // Geocode addresses to coordinates if needed
                if (typeof origin === "string" || typeof destination === "string") {
                    geocodeAndFindAccessibleStations(origin, destination);
                } else {
                    findAccessibleStationsAndRoute(origin, destination);
                }

                // Show the route steps container
                document.getElementById('route-steps').style.display = 'block';
                // Adjust map container to allocate space for route steps
                document.getElementById('map').style.width = '70%';
            } else {
                console.log("Please enter both a starting point and an ending point.");
            }
        }

        function clearRoute() {
            clearPolylines();
            clearDirectionsRenderers();
            document.getElementById('route-steps').style.display = 'none';
            document.getElementById('map').style.width = '100%';
        }

        function geocodeAndFindAccessibleStations(origin, destination) {
            const geocoder = new google.maps.Geocoder();
            let originGeocoded = false;
            let destinationGeocoded = false;

            if (typeof origin === "string") {
                geocoder.geocode({ address: origin }, (results, status) => {
                    if (status === "OK" && results[0]) {
                        origin = {
                            lat: results[0].geometry.location.lat(),
                            lng: results[0].geometry.location.lng()
                        };
                        startLocation = origin; // Store coordinates
                        console.log("Geocoded origin:", origin);
                        originGeocoded = true;
                        if (destinationGeocoded) {
                            findAccessibleStationsAndRoute(origin, destination);
                        }
                    } else {
                        console.log("Geocoding failed for origin:", status);
                        alert("Geocoding failed for origin: " + status);
                    }
                });
            } else {
                originGeocoded = true;
            }

            if (typeof destination === "string") {
                geocoder.geocode({ address: destination }, (results, status) => {
                    if (status === "OK" && results[0]) {
                        destination = {
                            lat: results[0].geometry.location.lat(),
                            lng: results[0].geometry.location.lng()
                        };
                        endLocation = destination; // Store coordinates
                        console.log("Geocoded destination:", destination);
                        destinationGeocoded = true;
                        if (originGeocoded) {
                            findAccessibleStationsAndRoute(origin, destination);
                        }
                    } else {
                        console.log("Geocoding failed for destination:", status);
                        alert("Geocoding failed for destination: " + status);
                    }
                });
            } else {
                destinationGeocoded = true;
            }

            // If both origin and destination are already geocoded (not strings), proceed
            if (originGeocoded && destinationGeocoded) {
                findAccessibleStationsAndRoute(origin, destination);
            }
        }

        function findAccessibleStationsWithinRadius() {
            if (!navigator.geolocation) {
                alert("Geolocation is not supported by this browser.");
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    // Get the selected radius from the slider in meters
                    const radius = parseFloat(document.getElementById('radius-slider').value) * 1609.34; // Convert miles to meters

                    // Clear existing markers
                    clearNearbyMarkers();

                    // Fetch accessible stations from the server-side context
                    const accessibleStations = JSON.parse(document.getElementById('accessible-stations').textContent);

                    // Filter stations within the radius and plot them
                    accessibleStations.forEach(station => {
                        const stationLocation = {
                            lat: parseFloat(station.gtfs_latitude),
                            lng: parseFloat(station.gtfs_longitude)
                        };
                        const distance = calculateDistance(userLocation, stationLocation);

                        if (distance <= radius) {
                            const stationMarker = new google.maps.Marker({
                                position: stationLocation,
                                map: map,
                                icon: 'https://maps.google.com/mapfiles/ms/icons/green-dot.png', // Green marker
                                title: station.stop_name
                            });

                            // Add click listener for the InfoWindow
                            stationMarker.addListener('click', function () {
                                // Close any active InfoWindow
                                if (activeInfoWindow) {
                                    activeInfoWindow.close();
                                }

                                const reviews = station.reviews || [];
                                const avgRating = station.avg_rating ? `${station.avg_rating}/5` : "No rating available";

                                // Format reviews for the popup
                                const reviewContent = reviews
                                    .map(review => `<p><strong>${review.user}:</strong> ${review.comment}</p>`)
                                    .join("");

                                // Construct InfoWindow content
                                const infoContent = `
                                    <div style="font-size: 14px; max-width: 250px;">
                                        <strong>${station.stop_name}</strong><br>
                                        Train Lines: ${station.daytime_routes || "N/A"}<br>
                                        Rating: ${avgRating}<br>
                                        ${reviewContent || "<p>No reviews yet.</p>"}
                                        <a href="https://www.google.com/maps?q=${station.gtfs_latitude},${station.gtfs_longitude}" target="_blank">View on Google Maps</a>
                                    </div>
                                `;

                                const infoWindow = new google.maps.InfoWindow({
                                    content: infoContent
                                });
                                infoWindow.open(map, stationMarker);

                                // Set the new active InfoWindow
                                activeInfoWindow = infoWindow;
                            });
                            // Add the station to the markers array to manage visibility
                            nearbyStationMarkers.push(stationMarker);
                        }
                    });

                    // Optionally, center the map on the user's location
                    map.setCenter(userLocation);

                    // Optionally, add a marker for the user's location
                    if (currentLocationMarker) {
                        currentLocationMarker.setMap(null);
                    }

                    currentLocationMarker = new google.maps.Marker({
                        position: userLocation,
                        map: map,
                        title: "Your Location",
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 6,
                            fillColor: '#4285F4', // Google blue color
                            fillOpacity: 1,
                            strokeColor: '#ffffff', // White border
                            strokeWeight: 2
                        }
                    });
                },
                (error) => {
                    alert("Error fetching current location: " + error.message);

                    if (error.code === error.PERMISSION_DENIED) {
                        // User denied geolocation, disable the button and update its text
                        const toggleStationsButton = document.getElementById('toggle-stations-button');
                        toggleStationsButton.disabled = true;
                        toggleStationsButton.innerText = 'Geolocation not enabled';
                    }
                }
            );
        }

        function clearDirectionsRenderers() {
            directionsRenderers.forEach(renderer => renderer.setMap(null));
            directionsRenderers = []; // Reset the array
        }

        function addCustomMarkers(origin, destination) {
            // Remove existing start marker
            if (startMarker) {
                startMarker.setMap(null);
            }
            // Remove existing end marker
            if (endMarker) {
                endMarker.setMap(null);
            }

            // Add custom start marker
            startMarker = new google.maps.Marker({
                position: origin,
                map: map,
                icon: 'http://maps.google.com/mapfiles/markerA.png', // Custom icon
                title: 'Start Point'
            });

            // Add custom end marker
            endMarker = new google.maps.Marker({
                position: destination,
                map: map,
                icon: 'http://maps.google.com/mapfiles/markerB.png', // Custom icon
                title: 'End Point'
            });
        }

        function routeWithSegments(origin, startStation, endStation, destination) {
            // Clear previous polylines and directions
            clearPolylines();
            clearDirectionsRenderers();

            // Convert coordinates to LatLng format if necessary
            const originLatLng = new google.maps.LatLng(origin.lat, origin.lng);
            const startStationLatLng = new google.maps.LatLng(startStation.latitude, startStation.longitude);
            const endStationLatLng = new google.maps.LatLng(endStation.latitude, endStation.longitude);
            const destinationLatLng = new google.maps.LatLng(destination.lat, destination.lng);

            document.getElementById('directions-list').innerHTML = "";

            // Add custom markers for start and end
            addCustomMarkers(originLatLng, destinationLatLng);

            // Create individual renderers for each segment and store them
            const walkingToStationRenderer = new google.maps.DirectionsRenderer({ 
                map: map, 
                suppressMarkers: true,
                preserveViewport: true,
                polylineOptions: { strokeColor: '#00bfff' }
            });
            directionsRenderers.push(walkingToStationRenderer); // Store the renderer

            const subwayRenderer = new google.maps.DirectionsRenderer({
                map: map,
                suppressMarkers: true,
                preserveViewport: true,
                polylineOptions: { strokeColor: '#ff4500' }
            });
            directionsRenderers.push(subwayRenderer); // Store the renderer

            const walkingToDestinationRenderer = new google.maps.DirectionsRenderer({
                map: map,
                suppressMarkers: true,
                preserveViewport: true,
                polylineOptions: { strokeColor: '#00bfff' }
            });
            directionsRenderers.push(walkingToDestinationRenderer); // Store the renderer

            // Step 1: Walk from origin to nearest accessible start station
            directionsService.route({
                origin: originLatLng,
                destination: startStationLatLng,
                travelMode: 'WALKING'
            }, function(walkToStationResult, status) {
                if (status === 'OK') {
                    walkingToStationRenderer.setDirections(walkToStationResult);
                    displayRouteSteps(walkToStationResult, "Walk to Start Station");

                    // Step 2: Transit between accessible stations
                    directionsService.route({
                        origin: startStationLatLng,
                        destination: endStationLatLng,
                        travelMode: 'TRANSIT',
                        transitOptions: { modes: ['SUBWAY'] }
                    }, function(transitResult, status) {
                        if (status === 'OK') {
                            subwayRenderer.setDirections(transitResult);
                            drawColoredOverlays(transitResult);
                            displayRouteSteps(transitResult, "Subway Route");

                            // Step 3: Walk from nearest accessible end station to final destination
                            directionsService.route({
                                origin: endStationLatLng,
                                destination: destinationLatLng,
                                travelMode: 'WALKING'
                            }, function(walkToDestinationResult, status) {
                                if (status === 'OK') {
                                    walkingToDestinationRenderer.setDirections(walkToDestinationResult);
                                    displayRouteSteps(walkToDestinationResult, "Walk to Final Destination");
                                } else {
                                    console.log("Error finding walking route to destination:", status);
                                }
                            });
                        } else {
                            console.log("Error finding subway route between stations:", status);
                        }
                    });
                } else {
                    console.log("Error finding walking route to start station:", status);
                }
            });
        }

        function findNearestStation(location) {
            console.log("Finding nearest station for location:", location);

            if (!accessibleStations || accessibleStations.length === 0) {
                console.log("Error: accessibleStations data is not available or empty.");
                return null;
            }

            let nearestStation = null;
            let shortestDistance = Infinity;

            accessibleStations.forEach((station) => {

                const stationLat = parseFloat(station.gtfs_latitude); // Ensure property names match your data
                const stationLng = parseFloat(station.gtfs_longitude);

                if (isNaN(stationLat) || isNaN(stationLng)) {
                    console.log(`Skipping station due to invalid coordinates: ${station}`);
                    return;
                }

                const distance = calculateDistance(location, { lat: stationLat, lng: stationLng });

                if (distance < shortestDistance) {
                    shortestDistance = distance;
                    nearestStation = { ...station, latitude: stationLat, longitude: stationLng }; // Attach as `latitude` and `longitude`
                }
            });

            console.log("Nearest station found:", nearestStation);
            return nearestStation;
        }

        function drawColoredOverlays(result) {
            const steps = result.routes[0].legs[0].steps;

            steps.forEach((step) => {
                if (step.transit) {
                    const transit = step.transit;
                    const lineShortName = transit.line.short_name.replace(" Line", "").trim();
                    const lineColor = subwayLineColors[lineShortName] || '#000000'; // Use color map or default to black

                    const path = google.maps.geometry.encoding.decodePath(step.polyline.points);

                    // Make the original Google polylines more transparent by overlaying with a nearly transparent line
                    const transparentLine = new google.maps.Polyline({
                        path: path,
                        geodesic: true,
                        strokeColor: "#000000", // Black (or other neutral color)
                        strokeOpacity: 0.1,  // Nearly transparent
                        strokeWeight: 5
                    });

                    transparentLine.setMap(map);
                    polylines.push(transparentLine);

                    // Overlay a slightly wider, more opaque colored line on top
                    const intensifiedLine = new google.maps.Polyline({
                        path: path,
                        geodesic: true,
                        strokeColor: lineColor,
                        strokeOpacity: 0.9,  // Higher opacity for subway line color
                        strokeWeight: 7     // Slightly thicker to stand out
                    });

                    intensifiedLine.setMap(map);  // Overlay colored subway line
                    polylines.push(intensifiedLine);
                }
            });
        }

        function clearPolylines() {
            polylines.forEach(polyline => polyline.setMap(null));
            polylines = [];
        }

        function displayRouteSteps(result, segmentLabel) {
            const directionsList = document.getElementById('directions-list');
            const segmentHeader = document.createElement('h4');
            segmentHeader.innerText = segmentLabel;
            directionsList.appendChild(segmentHeader);

            const steps = result.routes[0].legs[0].steps;
            steps.forEach((step) => {
                const listItem = document.createElement('li');
                
                if (step.transit) {
                    const transit = step.transit;
                    const lineName = transit.line.short_name.replace(" Line", "").trim();
                    const lineColor = subwayLineColors[lineName] || '#000000';

                    // Create train icon and display route step with the icon
                    const trainIcon = `<span class="train-icon" style="background-color:${lineColor};">${lineName}</span>`;
                    listItem.innerHTML = `${trainIcon} Take the <span style="color:${lineColor}; font-weight: bold;">${lineName}</span> subway from <strong>${transit.departure_stop.name}</strong> to <strong>${transit.arrival_stop.name}</strong>. Follow signs for ${transit.headsign}.`;
                } else {
                    listItem.innerHTML = `${step.instructions} - ${step.distance.text}`;
                }
                
                directionsList.appendChild(listItem);
            });
        }

        let showAccessibleOnly = false;
        let showAllStations = false;

        function setStationFilter() {
            map.data.setStyle(function(feature) {
                const isAccessible = feature.getProperty('ada') === "1";
                
                // Display logic based on selected filter
                return {
                    visible: showAccessibleOnly ? isAccessible : showAllStations,
                    icon: {
                        url: isAccessible ? "https://maps.google.com/mapfiles/ms/icons/red-dot.png" : "https://maps.google.com/mapfiles/ms/icons/blue-dot.png"
                    }
                };
            });
        }

        function setFilter(option) {

            clearNearbyMarkers();

            if (option === 'accessible') {
                showAccessibleOnly = true;
                showAllStations = false;
            } else if (option === 'all') {
                showAccessibleOnly = false;
                showAllStations = true;
            } else if (option === 'hide') {
                showAccessibleOnly = false;
                showAllStations = false;
            }
            // Reset the "Show Nearby Subway Stations" button text
            const toggleStationsButton = document.getElementById('toggle-stations-button');
            toggleStationsButton.innerText = 'Show Nearby Subway Stations';
            stationsVisible = false; // Reset the visibility state

            setStationFilter();
        }

        // Favourite a route
        function saveFavorite() {
            findRoute();
            if (startLocation && endLocation) {
                fetch("{% url 'app:save_favorite_route' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({ start: startLocation, end: endLocation })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert("Favorite route saved successfully!");
                    } else {
                        alert("Failed to save favorite route.");
                    }
                })
                .catch(error => console.error("Error:", error));
            } else {
                alert("Please enter both start and destination locations.");
            }
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function getCSRFToken() {
            return getCookie('csrftoken');
        }

        function findAccessibleStationsAndRoute(origin, destination) {
            // Find nearest accessible station to origin
            const startStation = findNearestStation(origin);
            // Find nearest accessible station to destination
            const endStation = findNearestStation(destination);

            if (startStation && endStation) {
                // Route between the points
                routeWithSegments(origin, startStation, endStation, destination);
            } else {
                console.log("Could not find accessible stations near origin or destination.");
                alert("Could not find accessible stations near origin or destination.");
            }
        }


    </script>
      
    <!-- Google Maps API script with async and defer -->
    <script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places&callback=initMap" async defer></script>

    <!-- Bootstrap JS (placed at the end for better performance) -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>